FROM ubuntu:xenial

ENV QTDIR="/usr"
ENV PKGS_DIR="/packages"
RUN mkdir $PKGS_DIR

RUN DEBIAN_FRONTEND=noninteractive apt-get update \
 && DEBIAN_FRONTEND=noninteractive apt-get install --no-install-recommends -y \
    autoconf                               \
    automake                               \
    bison                                  \
    ca-certificates                        \
    checkinstall                           \
    flex                                   \
    g++                                    \
    gdb                                    \
    git                                    \
    gperf                                  \
    libasound2-dev                         \
    libcap-dev                             \
    libdbus-1-dev                          \
    libegl1-mesa-dev                       \
    libfontconfig1-dev                     \
    libfreetype6-dev                       \
    libgl1-mesa-glx                        \
    libglib2.0-0                           \
    libglu1-mesa-dev                       \
    libgstreamer-plugins-base1.0-dev       \
    libgstreamer1.0-0                      \
    libicu-dev                             \
    libnss3-dev                            \
    libpci-dev                             \
    libpulse-dev                           \
    libssl-dev                             \
    libudev-dev                            \
    libx11-dev                             \
    libx11-xcb-dev                         \
    libxcb-glx0-dev                        \
    libxcb1-dev                            \
    libxcomposite-dev                      \
    libxcursor-dev                         \
    libxdamage-dev                         \
    libxext-dev                            \
    libxfixes-dev                          \
    libxi-dev                              \
    libxrandr-dev                          \
    libxrender-dev                         \
    libxslt-dev                            \
    libxss-dev                             \
    libxtst-dev                            \
    perl                                   \
    python                                 \
    ruby                                   \
    wget

WORKDIR /
RUN wget https://cmake.org/files/v3.11/cmake-3.11.4.tar.gz
RUN tar -xf cmake-3.11.4.tar.gz
WORKDIR /cmake-3.11.4
RUN ./bootstrap
RUN make -j4
RUN checkinstall -y                           \
    --pkgname=cmake                           \
    --pkgversion="3.11.4"                     \
    --pkgrelease="xenial-approximator1"       \
    --provides="cmake"                        \
    --requires=""                             \
    --pkgarch=$(dpkg --print-architecture)    \
    --pakdir=$PKGS_DIR                        \
    --nodoc                                   \
    --backup=no                               \
    --maintainer=alex@nls.la                  \
    -D make install

WORKDIR /
RUN wget -c https://download.qt.io/official_releases/qt/5.10/5.10.1/single/qt-everywhere-src-5.10.1.tar.xz
RUN mkdir qt-build && cd qt-build && tar xvf /qt-everywhere-src-5.10.1.tar.xz

WORKDIR /qt-build/qt-everywhere-src-5.10.1/
RUN ./configure --help                \
 && ./configure -prefix "/usr"        \
                -confirm-license      \
                -opensource           \
                -release              \
                -dbus-linked          \
                -openssl-linked       \
                -qt-zlib              \
                -qt-libjpeg           \
                -qt-libpng            \
                -qt-xcb               \
                -qt-xkbcommon         \
                -qt-xkbcommon-x11     \
                -qt-freetype          \
                -qt-pcre              \
                -qt-harfbuzz          \
                -icu

RUN make -j4
RUN checkinstall -y                           \
    --pkgname=qt                              \
    --pkgversion="5.10.1"                     \
    --pkgrelease="xenial-approximator1"       \
    --provides="qmake"                        \
    --requires="libgl1-mesa-glx"              \
    --pkgarch=$(dpkg --print-architecture)    \
    --pakdir=$PKGS_DIR                        \
    --nodoc                                   \
    --backup=no                               \
    --maintainer=alex@nls.la                  \
    -D make install

WORKDIR /qt-build/
RUN git clone -b v1.10.1 git://code.qt.io/qbs/qbs.git
RUN qmake -r qbs/qbs.pro
RUN make -j4
RUN checkinstall -y                        \
    --pkgname=qbs                          \
    --pkgversion="1.10.1"                  \
    --pkgrelease="xenial-approximator1"    \
    --provides="qbs"                       \
    --requires="libglib2.0-0"              \
    --pkgarch=$(dpkg --print-architecture) \
    --pakdir=$PKGS_DIR                     \
    --nodoc                                \
    --backup=no                            \
    --maintainer=alex@nls.la               \
    -D make install

RUN git clone https://github.com/NixOS/patchelf.git patchelf
WORKDIR /qt-build/patchelf
RUN ./bootstrap.sh && ./configure
RUN make -j4
RUN checkinstall -y                        \
    --pkgname=patchelf                     \
    --pkgversion="1.0.0-master"            \
    --pkgrelease="xenial-approximator1"    \
    --provides="patchelf"                  \
    --requires=""                          \
    --pkgarch=$(dpkg --print-architecture) \
    --pakdir=$PKGS_DIR                     \
    --nodoc                                \
    --backup=no                            \
    --maintainer=alex@nls.la               \
    -D make install


RUN ls -lah /
RUN ls -lah $PKGS_DIR
